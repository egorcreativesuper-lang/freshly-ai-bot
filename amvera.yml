name: freshly-bot
service:
  runtime: python
  version: 3.11

build:
  requirementsPath: requirements.txt

resources:
  memory: 512Mi
  cpu: 250m

environment:
  variables:
    # Обязательные переменные
    TELEGRAM_BOT_TOKEN: 8123646923:AAERiVrcFss2IubX3SMUJI12c9qHbX2KRgA
    WEBHOOK_URL: https://freshly.amvera.io
    
    # Дополнительные настройки
    LOG_LEVEL: "INFO"
    TZ: "Europe/Moscow"
    
    # Настройки вебхука
    WEBHOOK_MODE: "true"
    PORT: "8080"

deploy:
  instances: 1

  probes:
    liveness:
      httpGet:
        path: /health
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 60
      timeoutSeconds: 10

    readiness:
      httpGet:
        path: /health
        port: 8080
      initialDelaySeconds: 20
      periodSeconds: 30
      timeoutSeconds: 5

  scaling:
    auto:
      min: 1
      max: 2
      cpu: 70

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

# Сборка и запуск
buildCommands:
  - echo "Installing dependencies..."
  - pip install -r requirements.txt

runCommand: python bot.py

# Health check endpoint (добавьте этот код в ваш bot.py)
healthCheck:
  path: /health
  port: 8080

# Логирование
logging:
  enabled: true
  level: info

# Persistence для базы данных
persistence:
  enabled: true
  size: 1Gi
  mountPath: /app/data

# Безопасность
securityContext:
  runAsNonRoot: true
  runAsUser: 1001

# Дополнительные настройки
config:
  # Перезапуск при ошибках
  restartPolicy: always
  
  # Ограничения ресурсов
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "250m"
